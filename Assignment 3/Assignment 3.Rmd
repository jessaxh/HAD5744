---
title: "Assignment 3"
author: "Husayn Jessa and Aidan Bodner"
date: "16/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages
```{r Packages}
library(here)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(ggtext)
library(showtext)
library(stringr)
library(fastDummies)
library(modelsummary)
library(lubridate)
library(gtsummary)
library(fixest)
library(quantreg)

```

# Data and Cleaning
```{r Data and Cleaning}
name <- Sys.info() 
name[7]

assign_data <- read.csv("a3_p1_sourdough_trends.csv")

```

# Question 1a
```{r Question 1a}

assign_data$date <- str_replace_all(assign_data$date, "T00:00:00Z", "")
assign_data$date <- as.factor(assign_data$date)
assign_data$date <- as.numeric(assign_data$date) 

q1_line_graph <- ggplot(assign_data, (aes(x = date, y = hits, group = keyword))) + 
  geom_line(aes(color = keyword)) + theme_linedraw() + labs(x = "Date", y = "Hits") +
  geom_vline(xintercept = as.numeric(assign_data$date[75]), 
    color = "red") + geom_text(aes(x = as.numeric(date[120]), label="Start of Pandemic (2020-03-15)", y=90), color = "red") +
  scale_x_discrete(breaks = c("2020-01-01",
                              "2020-02-01",
                              "2020-03-01",
                              "2020-04-01",
                              "2020-05-01",
                              "2020-06-01",
                              "2020-07-01",
                              "2020-08-01"), labels = waiver())

q1_line_graph


#I wanted to make a line graph without converting our dates to numeric:

#create column new_date to change the date variable into dates
assign_data$date <- str_replace_all(assign_data$date, "T00:00:00Z", "")
assign_data$new_date <- ymd(assign_data$date)
class(assign_data$new_date)

hq1_line_graph <- ggplot(assign_data, aes(x = date, y = hits, colour = keyword, group = keyword)) +
                theme_classic()  + geom_vline(xintercept = assign_data$date[75], show.legend = FALSE) + annotate("text", x=assign_data$date[70], y=86, label="Start of Pandemic ", angle=90) + geom_line() +  scale_x_discrete(breaks = c("2020-01-01",
                              "2020-02-01",
                              "2020-03-01",
                              "2020-04-01",
                              "2020-05-01",
                              "2020-06-01",
                              "2020-07-01",
                              "2020-08-01")) + ggtitle("Interest in Food Types Over Time")

hq1_line_graph

# Look at plot at pre-treatment, to gauge trend lines and similarities or differences: 

hq1_line_graph + coord_cartesian(xlim= c(0,76))
#we can see before the start of the pandemic sourdough looked similar to cereal but did not look anything like soup or sandwich so considering droping thos



```
Based on the graph we created, when the pandemic started there were temporary effects on the popularity of sourdough bread. From the graph we can see that after the start of the pandemic the hits for sourdough increased to a certain point then started to decline back to pre pandemic levels. For cereal and sandwich respectively, their popularity levels remained relatively the same before and after the pandemic started. Soup was experiencing a decline in popularity before the pandemic began and then experienced a small increase in popularity when the pandemic began but soon after continued its descent in popularity. As sourdough is our variable of interest, it was interesting to see that the levels in popularity increased for a few months after the pandemic began however it appears that as people got used to living in the pandemic, they returned to their pre pandemic habits. 

Sourdough bread will be considered our Treated group and thus when looking at the other foods as controls, some are more appropriate than others. When the graph was zoomed in to look at the popularity trends before the pandemic began it can be noted that the trend of sourdough bread looks most like that of cereal. They both experience low peaks and dips in their popularity trend line and have very similar locations at where these peaks and dips occur. Sourdough's trend line and sandwich's trend line do not look as similar, as sandwich popularity appears to have much more changes and sharper dips and peaks than that of sourdough's. The trend line for soup is the most distinct from that of sourdoughs as it has large variation in popularity over time and it has a clear downard trend in popularity. Based on the pre-pandemic trend lines, it appears that cereal would serve as the best control group for sourdough as the two trend lines look very similar and thus without any impactful events (such as a pandemic) it could be predicted that their trend lines would look similar if extrapolated. 


# Question 1b
```{r Question 1b}

# Create Treated Variable for sourdough https://www.princeton.edu/~otorres/DID101R.pdf

regdata <- assign_data %>% mutate(treated = ifelse(keyword == "sourdough", 1, 0)) 

# Create a dummy variable to indicate the time when the treatment started. 

regdata <- regdata %>% mutate(pandemic_begun = ifelse(date >= "2020-03-15", 1, 0))

# Create interaction variable between treated and beginning of pandemic

regdata <- regdata %>% mutate(interaction = treated*pandemic_begun)

# Statistical tests: are the two groups' trends different?
pretrend_test <- lm(hits ~ treated + pandemic_begun + interaction, data=regdata)
msummary(list(pretrend_test),
         vcov=c(rep("robust",1)),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # Interpret each coefficient here

# Dropping Control Groups

# Dropping soup and sandwich from data 
new_regdata <- regdata %>% filter(keyword %in% c("sourdough","cereal"))

unique(new_regdata$keyword)

new_pretrend_test <- lm(hits ~ treated + pandemic_begun + interaction, data=new_regdata)

msummary(list(pretrend_test, new_pretrend_test),
         vcov=c(rep("robust",1)),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # Interpret each coefficient here

#i think this is how you do it but im not sure


```
The regression results for either the model where we keep all the control groups or the model where we drop soup and sandwich are not concerning. If we hypothesize that sourdough popularity only begun at the pandemic start date (2020-03-15), then it would be likely that any given search for sourdough would result in an increase in hits. Similarly, it is difficult to say that internet traffic (hits), for any of the dates after the pandemic start would be more or less than that before the pandemic. Therefore, the negative coefficients for treated and pandemic_begun variables are not concerning. The interaction term makes sense given our hypothesis as it indicates a positive change in hits for sourdough after the pandemic start date compared to before. 

When we drop the other control variables, our standard errors decrease and our R^2 increases, indicating a more precise estimate of the number of hits and better model fit. For this reasons as well, we are not concerned.


# Question 1c
```{r Question 1c}


#create a relative_month variable by shifting the "date" variable back 15 days (so that the treatment day is the first day of the month)  and then taking the month of the resulting date 
new_regdata <- new_regdata %>% mutate(relative_month = new_date - 14)     
#shift date back 15 days, used new_date instead of date as date is a character while new date is the class date
# I used 14 so that the treatment day is may first rather than February 29  


#create an "After" variable equal to 1/0 or True/False if the date is March 15 or afterwards 

new_regdata <- new_regdata %>% mutate(After = ifelse(relative_month >= "2020-03-15", 1, 0 )) 


#illustrate how the values of "relative_month" line up with "date" and subtract a number from "relative_month" so the last period just before treatment (Feb 16 - Mar 14)  is 0. (Also, change the Jan 1 -14 month so it's one less than the Jan 15- Feb 14 month) 

relative_month_date_illustration <- new_regdata %>% select(relative_month, new_date)

#table with relative month and new date next to each other 
relative_month_date_illustration <- relative_month_date_illustration %>% mutate(diff_bt_date = difftime(new_date, relative_month, units = "days"))

plot(relative_month_date_illustration$diff_bt_date)

q_c_table <- tibble(relative_month_date_illustration)


```

# Question 1d
```{r Question 1d}

#Use two-way fixed effects to estimate the difference-in-difference estimate of the effect of lockdown on sourdough popularity. What are your two fixed effects? 

fixed_effects_model <- feols(hits ~ treated | pandemic_begun + interaction, data = new_regdata)
#idk what fixed effects we have to include here also not sure if we include all 3 of these variables in the ols  (maybe include keyword as the fixed effect but that introduces colineaarity with treated)
fixed_effects_model


#report and interper results, with standard errors clustered at keyword level 

msummary(fixed_effects_model, vcov= ~keyword, fmt = '%#.8f') #is this how you cluster by keyword level haha
```

#PART 3 Quantile and Nonparametric Regression

```{r Data and Cleaning}
name <- Sys.info() 
name[7]

here()
load("/Users/husaynjessa/Documents/GitHub/HAD5744/Assignment 3/a3_p3_medicare.RData")

```

# Question 3a
```{r Question 3a}
# Construct Medicare coverage variable (1 = covered; 0 = not covered)
mydata <- mydata %>% mutate(medicare = ifelse(agex >= 65, 1, 0)) 

medicare <- mydata[mydata$medicare == 1, ]
no_medicare <- mydata[mydata$medicare == 0, ]

# View distribution of out-of-pocket medical spending for spending after Medicare coverage
ggplot(medicare, aes(x=totexp)) + geom_histogram() + geom_histogram(bins = 100) + xlim(0, 100000) + ylim(0, 20000)

# View distribution of out-of-pocket medical spending for spending before Medicare coverage
ggplot(no_medicare, aes(x=totexp)) + geom_histogram() + geom_histogram(bins = 100) + xlim(0, 25000) + ylim(0, 100000)

```
Examining the two histograms shows that those with Medicare incur less out-of pocket expenses than those with no Medicare coverage. While these histograms give us a good starting point to believe that this may be the case, we cannot claim that this is a causal relationship as we have not accounted for unexplained variation between these two groups.


# Question 3b
```{r Question 3b}
naive_ols <- lm(totexp ~ medicare + cancerdx + sex + racex + faminc, data = mydata, weights = perwt) # We will have to figure out what we want to control for
summary(naive_ols)

attach(mydata)

hist(totexp)
hist(log(totexp))
#based on the histograms we decide to log totexp

view(mydata$log_totexp)

naive_ols <- lm(log(totexp) ~ medicare + cancerdx + sex + racex + faminc, data = mydata, weights = perwt) # We will have to figure out what we want to control for 
#idk why log(totexp) not running but i know we need to 
summary(naive_ols)

```
# Question 3c
```{r Question 3c}
library(quantreg)

quant_reg <- rq(totexp ~ medicare + cancerdx + sex + racex, tau= c(0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75,
            0.8, 0.85, 0.9, 0.95, 0.1) , data = mydata, weights = perwt)


summary(quant_reg)


mytau <- rep(NA,20) # empty vector: quantiles
coefs <- rep(NA, 20) # empty vector: coefficients
lb <- rep(NA, 20) # empty vector: 95% LB
ub <- rep(NA, 20) # empty vector: 95% UB
for (t in 1:20) {
  mytau[t] <- t/20 # indicate which decile I am using
  print(paste0("Considering quantile ",mytau[t],sep=" "))
quantreg <- rq(totexp ~ medicare + cancerdx + sex + racex + faminc, data = mydata, weights = perwt,
              tau = mytau[t]) # tau ranges from 0 to 1
  coefs[t] <- quantreg$coefficients[2]
  quantsummary <- summary(quantreg)
}



# Construct a figure of coefficients across distribution
plotdata <- data.frame(mytau,coefs,lb,ub)
plotdata %>%ggplot(aes(x=mytau))+
  geom_point(aes(y=coefs),size=2,color='blue') + 
  geom_errorbar(aes(ymin = lb, ymax = ub),width=0.03) + 
  scale_y_continuous(labels=scales::dollar_format()) + 
  theme_classic() + labs(x="Quantile", y="Estimated Marginal Effect of Activity Limitation on Health Spending")


```

```{r Question 3d}

```


```{r Question 3e}

```


```{r Question 3f}

```


```{r Question 3g}

```


```{r Question 3h}

```


