---
title: "Assignment 2 - A Matching Exercise"
author: "Husayn Jessa and Aidan Bodner"
date: "28/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Packages}
library(here)
library(haven)
library(tidyr)
library(dplyr)
library(gtsummary)
library(vtable)
library(MatchIt)
library(modelsummary)
library(ggplot2)

```

```{r Data Cleaning}
here()
assign_data <- read_dta("/Users/husaynjessa/Documents/GitHub/HAD5744/Assignment 2/Dataset2a_Claims (1).dta")

assign_data %>%
  summarise_all(funs(sum(is.na(.)))) # Returns no NAs, can probably remove

```

--------------------------------------------------------------------------------

``` {r Question 1a }

assign_data$sex <- as.factor(assign_data$sex) # Convert sex from a character to a factor
assign_data$sex <- as.numeric(assign_data$sex) # Convert sex from a character to a numeric


tbl_summary(data = assign_data, by = "hdhp",
            type = list(age ~ "continuous",
                        famsize ~ "continuous",
                        policyholder ~ "categorical",
                        num_hospitalizations ~ "continuous",
                        num_chronicconditions ~ "continuous",
                        num_scrips ~ "continuous",
                        sex ~ "categorical"),
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            digits = everything() ~ 2,
            include = c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips")) %>%
  add_p(test = everything() ~ "t.test")

```
From the p-values obtained from performing the t-test, we can see that there is no statistical differences between people in HDHP compared to other individuals in terms of age, if they are a policyholder, number of hospitalizations, and number of chronic conditions. However, the groups are not comparable in terms of sex, family size, and number of prescriptions.

We might expect to see significant differences in the distribution of HDHP by family size as people with larger families may be incentivized to find innovative ways to save costs. In terms of the number of prescriptions, people who already need more prescriptions will likely enroll in a plan that allows them to save money on future prescriptions. In terms of sex, females are more likely to engage in care seeking or plan for a future medical event than males making it conceivable that they would be statistically likely to be in an HDHP.

# Assumes that 2 is coded as female

--------------------------------------------------------------------------------

```{r Question 1b}

one_b_reg_naive <- lm(pay ~ hdhp + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                  data = assign_data)

msummary(one_b_reg_naive)

model_view_1 <- lm(pay~sex, data = assign_data)
model_view_2 <- lm(pay~famsize, data = assign_data)
model_view_3 <- lm(pay~num_scrips, data = assign_data)

plot(assign_data$sex, assign_data$pay)                       
abline(coef(model_view_1), col="gray")


```
The results from (a) suggest that for characteristics such as age, if they are a policyholder, number of hospitalizations, and number of chronic conditions, we can likely assume that since there is no statistical difference in the means that the fit of the regression is fairly good. However, for characteristics such as sex, family size, and number of prescriptions, there are statistical differences in the means indicating that the regression line likely is not able to fit the observations as well. The differences in these groups shown in (a) show more females than males, higher means family size, and higher number of hospitalizations, indicating that there is likely an overestimate of the true causal effect when comparing people enrolled in HDHP compared to those not enrolled.


--------------------------------------------------------------------------------

```{r Question 1c}

question1c_match <- matchit(hdhp ~ num_hospitalizations,
                            data = assign_data,
                            method = "exact")
summary(question1c_match)

regdata <-  match.data(question1c_match)

question1c_reg <- lm(pay ~ hdhp, data = regdata)

msummary(question1c_reg)
```


--------------------------------------------------------------------------------

```{r Question 1d}

question1d_match <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                  replace = TRUE,
                  distance = "scaled_euclidean")
summary(question1d_match)

qd_match_data <-  match.data(question1d_match)

matched_balance_table <- sumtable(data=qd_match_data,group="hdhp",
                                  out = "return",
                  vars=c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips"),
                  digits=2, group.test=T)

#try to use balance table for question 1 a to 1d however not working
matched_balance_table <- tbl_summary(data = question1d_match, by = "hdhp",
                        type = list(age ~ "continuous",
                        famsize ~ "continuous",
                        policyholder ~ "categorical",
                        num_hospitalizations ~ "continuous",
                        num_chronicconditions ~ "continuous",
                        num_scrips ~ "continuous",
                        sex ~ "categorical"),
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            digits = everything() ~ 2,
            include = c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips")) %>%
  add_p(test = everything() ~ "t.test")

question1d_reg <- lm(pay ~ hdhp, data = qd_match_data)

msummary(question1d_reg)

```


--------------------------------------------------------------------------------

```{r Question 1e}
question1e_match <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  replace = TRUE
                  )
summary(question1e_match)


qe_psmmatch_data <- match.data(question1e_match)


matched_psm_balance_table <- sumtable(data=qe_psmmatch_data,group="hdhp",
                                  out = "return",
                  vars=c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips"),
                  digits=2, group.test=T)

question1e_reg <- lm(pay ~ hdhp, data = qe_psmmatch_data)

msummary(question1e_reg)

hist(qe_psmmatch_data$distance) # Look at overall distribution of propensity scores

ggplot(qe_psmmatch_data,aes(x=distance, fill = factor(pay))) + 
  geom_histogram(binwidth = .05,color='black') + 
  theme_minimal() +
  labs(x="Propensity Score", y="Count",fill="pay")

```



--------------------------------------------------------------------------------

```{r Question 1f}

# Caliper set to 0.01
question1f_one <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.01),
                  replace = TRUE
                  )
summary(question1f_one)

# Caliper set to 0.1
question1f_two <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.1),
                  replace = TRUE
                  )
summary(question1f_two)

# Caliper set to 0.2
question1f_three <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.2),
                  replace = TRUE
                  )
summary(question1f_three)

# Caliper set to 0.5
question1f_four <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.5),
                  replace = TRUE
                  )
summary(question1f_four)

# Caliper set to 1
question1f_five <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(1),
                  replace = TRUE
                  )
summary(question1f_five)


# ADD IN BALANCE TABLE AFTER THEY ARE COMPLETED HOW TO



match_data_one <- match.data(question1f_one)
match_data_two <- match.data(question1f_two)
match_data_three <- match.data(question1f_three)
match_data_four <- match.data(question1f_four)
match_data_five <- match.data(question1f_five)

question1f_one_reg <- lm(pay ~ hdhp, data = match_data_one)
question1f_two_reg <- lm(pay ~ hdhp, data = match_data_two)
question1f_three_reg <- lm(pay ~ hdhp, data = match_data_three)
question1f_four_reg <- lm(pay ~ hdhp, data = match_data_four)
question1f_five_reg <- lm(pay ~ hdhp, data = match_data_five)

msummary(question1f_one_reg)
msummary(question1f_two_reg)
msummary(question1f_three_reg)
msummary(question1f_four_reg)
msummary(question1f_five_reg)


```


--------------------------------------------------------------------------------
#Part G






--------------------------------------------------------------------------------
#Part H










