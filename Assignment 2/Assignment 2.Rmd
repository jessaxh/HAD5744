---
title: "Assignment 2 - A Matching Exercise"
author: "Husayn Jessa and Aidan Bodner"
date: "28/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Packages}
library(here)
library(haven)
library(tidyr)
library(dplyr)
library(gtsummary)
library(vtable)
library(MatchIt)
library(modelsummary)
library(ggplot2)

```

```{r Data Cleaning}
here()
assign_data <- read_dta("/Users/aidanbodner/Documents/GitHub/HAD5744/Assignment 2/Dataset2a_Claims (1).dta")

assign_data %>%
  summarise_all(funs(sum(is.na(.)))) # Returns no NAs, can probably remove

```

--------------------------------------------------------------------------------

``` {r Question 1a }

assign_data$sex <- as.factor(assign_data$sex) # Convert sex from a character to a factor
assign_data$sex <- as.numeric(assign_data$sex) # Convert sex from a character to a numeric


tbl_summary(data = assign_data, by = "hdhp",
            type = list(age ~ "continuous",
                        famsize ~ "continuous",
                        policyholder ~ "categorical",
                        num_hospitalizations ~ "continuous",
                        num_chronicconditions ~ "continuous",
                        num_scrips ~ "continuous",
                        sex ~ "categorical"),
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            digits = everything() ~ 2,
            include = c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips")) %>%
  add_p(test = everything() ~ "t.test")

```
From the p-values obtained from performing the t-test, we can see that there is no statistical differences between people in HDHP compared to other individuals in terms of age, if they are a policyholder, number of hospitalizations, and number of chronic conditions. However, the groups are not comparable in terms of sex, family size, and number of prescriptions.

We might expect to see significant differences in the distribution of HDHP by family size as people with larger families may be incentivized to find innovative ways to save costs. In terms of the number of prescriptions, people who already need more prescriptions will likely enroll in a plan that allows them to save money on future prescriptions. In terms of sex, females are more likely to engage in care seeking or plan for a future medical event than males making it conceivable that they would be statistically likely to be in an HDHP.

# Assumes that 2 is coded as female

--------------------------------------------------------------------------------

```{r Question 1b}

one_b_reg_naive <- lm(pay ~ hdhp + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                  data = assign_data)

msummary(one_b_reg_naive)

model_view_1 <- lm(pay~sex, data = assign_data)
model_view_2 <- lm(pay~famsize, data = assign_data)
model_view_3 <- lm(pay~num_scrips, data = assign_data)

plot(assign_data$sex, assign_data$pay)                       
abline(coef(model_view_1), col="gray")

```
The results from (a) suggest that for characteristics such as age, if they are a policyholder, number of hospitalizations, and number of chronic conditions, we can likely assume that since there is no statistical difference in the means, that the fit of the regression is fairly good. However, for characteristics such as sex, family size, and number of prescriptions, there are statistical differences in the means indicating that the regression line likely is not able to fit the observations as well. The differences in these groups shown in (a) show more females than males, higher means family size, more likely to be a policyholder, and higher number of prescriptions for those who enroll in high deductibale health plans (HDHPs). Thus when looking at the reported regression coefficients they do not accurately show the true effect these variables have on the outcome variable as there is a statistically significant difference within these variables for those who are in a HDHP. 

There is an underestimated effect for these coefficients as a result, as we expect people enrolled in HDHPs to spend more as they are more likely to engage in healthcare seeking due to a higher likelihood of being female, having higher average family sizes, being a policyholder, and having higher average number of prescriptions. Thus these variables underestimate the true causal effect. 

--------------------------------------------------------------------------------
#for question 1c and beyond i used the weights for the regressions he used in class, i think were supposed to and it makes the regression coefficients similar in 1d and 1e which makes more sense as they both match using all variables and their results thus should be similar

```{r Question 1c}

question1c_match <- matchit(hdhp ~ num_hospitalizations,
                            data = assign_data,
                            method = "exact")
summary(question1c_match)

regdata <-  match.data(question1c_match)

question1c_unmatched_reg <- lm(pay ~ hdhp, data = assign_data)

question1c_reg <- lm(pay ~ hdhp, data = regdata, weights = weights)

msummary(list(question1c_unmatched_reg,question1c_reg))



onlyhospitalizations_matched_balance_table <- sumtable(data=regdata,group="hdhp",
                                  out = "return",
                  vars=c("num_hospitalizations"),
                  digits=2, group.test=T)
```
The back door being closed by matching the HDHP group with the non-HDHP group is the back door associated with inpatient hospitalizations. Through matching both groups on the # of hospitalizations, it is possible to say that both groups are similar with regards to this variable. This means that between the two groups there is no variations with regards to hospitalizations and as a result  we can more accurately depict the relationship between HDHP and spending. With regards to the quality of our match, we can note that there was not many members of the control group that went unmatched (88 people) and there were 0 people discarded from the match. As we noted from 1a. their is no significant differences between the comparison groups and thus as expected there were many matches for the treatment group. The quality of this match is poor because most of the control matched to the treatment group and thus the following regression does not provide any new information prior to the match. 
#i think its poor but we can discuss
The regression results show that after matching on inpatient hospitalizations occurred, the regression coefficient of HDHP was 1770.65. Thus, for individuals who are enrolled in the HDHP they had an increased spending of $1770.65 in comparison to those who were not enrolled in an HDHP. In comparison to a regression that looks at the effects of HDHP on spending before matching for inpatient hospitilizations we can see that after matching the effect of HDHP is higher. Prior to matching the regression coefficient was 658.71 which is much lower than 1770.65. 

--------------------------------------------------------------------------------

```{r Question 1d}

question1d_match <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                  replace = TRUE,
                  distance = "scaled_euclidean",
                  verbose = TRUE)
summary(question1d_match)

q_d_match_data <-  match.data(question1d_match)

write.csv(q_d_match_data, "/Users/aidanbodner/Documents/GitHub/HAD5744/Assignment 2/Question_1d_matched_data.csv")


q_d_match_data$sex <- as.factor(q_d_match_data$sex) # Convert sex from a character to a factor
q_d_match_data$sex <- as.numeric(q_d_match_data$sex) # Convert sex from a character to a numeric

q_d_matched_balance_table <- tbl_summary(data = q_d_match_data, by = "hdhp",
                        type = list(age ~ "continuous",
                        famsize ~ "continuous",
                        policyholder ~ "categorical",
                        num_hospitalizations ~ "continuous",
                        num_chronicconditions ~ "continuous",
                        num_scrips ~ "continuous",
                        sex ~ "categorical"),
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            digits = everything() ~ 2,
            include = c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips")) %>%
  add_p(test = everything() ~ "t.test")

question1d_reg <- lm(pay ~ hdhp, data = q_d_match_data, weights = weights)

msummary(question1d_reg)

```
Looking at the number of observations included in the balance table we can see that there has been a large reduction in the number of people included in our comparison group. It can be observed that the comparison group (non-HDHP) there are 5189 people who have been matched. When all covariates were included and nearest neighbour matching occurred, 224,983 people in the control group were unmatched with the treated group (### Could just say in the sample since its 224,983 across both groups that weren't matched ###). In comparison to the results of (c), only 88 people in the control group were unmatched. This shows that when all covariates are matched on and all the variation associated with these covariates is removed the amount of people who look like the HDHP group is a lot smaller. The regression results for this newly matched sample brings us closer to the true causal effect of HDHP on spending. After this more comprehensive match in comparison that of (c), we can see the regression coefficient for HDHP has increased to 4030.98, thus showing that being enrolled in HDHP has a much larger effect on spending than earlier noted. 

#used the balance table with the f test but we can change the values once we figure out the t test table here
When looking at the balance table  we can see that the mean age difference between the two groups is 0.28. the difference in mean of sex is 0.01. The difference in mean family size is 0.03, the difference in mean of policyholder is 0.01, the difference in mean of num_hospitilizations is 0.02, the difference in mean for num_chronicconditions is 0.01 and the difference in num_scrips is 0.06. As we can see there is now very little difference between the two groups and thus we know that the variation for these variables has been removed. Moreover, looking at the p-value for the t-tests, we can further see that there is no statistical difference for any of the covariates.

--------------------------------------------------------------------------------

```{r Question 1e}
question1e_match <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  replace = TRUE
                  )
summary(question1e_match)


qe_psmmatch_data <- match.data(question1e_match)
write.csv(qe_psmmatch_data, "/Users/aidanbodner/Documents/GitHub/HAD5744/Assignment 2/Question_1e_matched_data.csv")

qe_psmmatch_data$sex <- as.factor(qe_psmmatch_data$sex) # Convert sex from a character to a factor
qe_psmmatch_data$sex <- as.numeric(qe_psmmatch_data$sex) # Convert sex from a character to a numeric

q_e_matched_balance_table <- tbl_summary(data = qe_psmmatch_data, by = "hdhp",
                        type = list(age ~ "continuous",
                        famsize ~ "continuous",
                        policyholder ~ "categorical",
                        num_hospitalizations ~ "continuous",
                        num_chronicconditions ~ "continuous",
                        num_scrips ~ "continuous",
                        sex ~ "categorical"),
            statistic = list(all_continuous() ~ "{mean} ({sd})",
                             all_categorical() ~ "{n} ({p}%)"),
            digits = everything() ~ 2,
            include = c("age", "sex", "famsize", "policyholder",
                  "num_hospitalizations", "num_chronicconditions", "num_scrips")) %>%
  add_p(test = everything() ~ "t.test")

question1e_reg <- lm(pay ~ hdhp, data = qe_psmmatch_data, weights = 1/distance)

msummary(question1e_reg)

hist(qe_psmmatch_data$distance) # Look at overall distribution of propensity scores

ggplot(qe_psmmatch_data, aes(x=distance, fill = pay)) + 
  geom_histogram(binwidth = .05,color='black') + 
  theme_minimal() +
  labs(x="Propensity Score", y="Count",fill="pay")

```
With a propensity score approach we see similar results with regards to how many members of our control group got matched to the treatment group, 2522 members. Like the nearest neighbour approach in question (d), the match results using the propensity approach are much better than that of (c). 
Under this approach, the HDHP regression coefficient is now 4518.85 which is close to the regression coefficient of nearest neighbour (4030.98) but a bit higher. 

In the balance table we can see that there is a 0.68 difference in the mean age, a 0.01 difference in the mean sex, no difference between the mean famsize or mean policyholder, there is a 0.06 difference in the mean num_hospitilizations, a 0.05 difference in the num_chronnicconditions, and a 0.21 difference in the mean num_scrips. The results are similar to that of nearest neighbour matching however we can see that the differences for mean age and mean num_scrips have increased in comparison to those for nearest neighbour. As with the nearest neighbour matching, there are no statistical differences for any of the covariates apart from the num_hospitalizations. This indicates that while the propensity score approach is able to attain similar results to the number of participants matched, it is not able to do so in as a sophisticated a manner as nearest neighbour matching.

The PSM assumptions are valid as we can see that the propensity socres are evenly distributed across all payment spending.

--------------------------------------------------------------------------------

```{r Question 1f}

# Caliper set to 0.01
question1f_one <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.01),
                  replace = TRUE
                  )
summary(question1f_one)

# Caliper set to 0.1
question1f_two <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.1),
                  replace = TRUE
                  )
summary(question1f_two)

# Caliper set to 0.2
question1f_three <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.2),
                  replace = TRUE
                  )
summary(question1f_three)

# Caliper set to 0.5
question1f_four <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(0.5),
                  replace = TRUE
                  )
summary(question1f_four)

# Caliper set to 1
question1f_five <- matchit(hdhp ~ num_hospitalizations + age + sex + famsize + policyholder +
                  num_hospitalizations + num_chronicconditions + num_scrips,
                            data = assign_data,
                            method = "nearest",
                   distance='glm', # generalized linear model for propensity,
                  caliper = c(1),
                  replace = TRUE
                  )
summary(question1f_five)


# ADD IN BALANCE TABLE AFTER THEY ARE COMPLETED HOW TO



match_data_one <- match.data(question1f_one)
match_data_two <- match.data(question1f_two)
match_data_three <- match.data(question1f_three)
match_data_four <- match.data(question1f_four)
match_data_five <- match.data(question1f_five)

question1f_one_reg <- lm(pay ~ hdhp, data = match_data_one, weights = weights)
question1f_two_reg <- lm(pay ~ hdhp, data = match_data_two, weights = weights)
question1f_three_reg <- lm(pay ~ hdhp, data = match_data_three, weights = weights)
question1f_four_reg <- lm(pay ~ hdhp, data = match_data_four, weights = weights)
question1f_five_reg <- lm(pay ~ hdhp, data = match_data_five, weights = weights)

msummary(question1f_one_reg)
msummary(question1f_two_reg)
msummary(question1f_three_reg)
msummary(question1f_four_reg)
msummary(question1f_five_reg)


```


--------------------------------------------------------------------------------
#Part G






--------------------------------------------------------------------------------
#Part H










